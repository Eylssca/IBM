<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>AI Show Director Demo</title>
  <meta name="viewport" content="width=device-width, initial-scale=1" />
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; font-family: system-ui, sans-serif; }

    body {
      background: #050318;
      color: #fff;
      display: flex;
      flex-direction: column;
      height: 100vh;
      overflow: hidden;
    }

    #top-bar {
      padding: 10px 20px;
      font-size: 18px;
      font-weight: 600;
      background: linear-gradient(90deg,#0f172a,#1e293b);
      border-bottom: 1px solid #334155;
    }

    #layout {
      display: grid;
      grid-template-columns: 2fr 1fr;
      gap: 16px;
      padding: 16px;
      flex: 1;
      position: relative;
    }

    /* --- STAGE AREA --- */
    #stage-wrapper {
      position: relative;
      border-radius: 24px;
      overflow: hidden;
      background: radial-gradient(circle at top, #1d2b64, #050318);
      box-shadow: 0 0 40px rgba(0,0,0,0.7);
      display: flex;
      justify-content: center;
      align-items: center;
    }

    /* Background container for image or video */
    #background-content {
      position: absolute;
      inset: 0;
      width: 100%;
      height: 100%;
      object-fit: cover;
      z-index: 1;
    }

    #stage-wrapper * {
        mix-blend-mode: screen;
    }

    #beam-layer {
      position: absolute;
      inset: 0;
      pointer-events: none;
      mix-blend-mode: screen;
      z-index: 4;
    }

    .beam {
      position: absolute;
      width: 30%;
      height: 120%;
      top: -20%;
      background: radial-gradient(circle at 50% 0%, rgba(255,255,255,0.9), transparent 65%);
      opacity: 0.25;
      transform-origin: top center;
      animation: beamSwing 4s ease-in-out infinite alternate;
      filter: blur(3px);
    }
    .beam.b1 { left: 20%; }
    .beam.b2 { left: 50%; animation-delay: 1s; }
    .beam.b3 { left: 80%; animation-delay: 2s; }

    @keyframes beamSwing {
      0% { transform: rotate(-12deg);}
      100% { transform: rotate(12deg);}
    }

    #ai-filter {
      position: absolute;
      inset: 0;
      mix-blend-mode: screen;
      background: radial-gradient(circle at 50% 20%, rgba(255,0,255,0.4), transparent 70%);
      opacity: 0.0;
      transition: opacity 0.4s ease, background 0.4s ease;
      pointer-events: none;
    }

    /* lyric / chat wall */
    #lyric-wall {
      position: absolute;
      left: 20px;
      top: 20px;
      width: 32%;
      max-height: 60%;
      padding: 12px 18px;
      border-radius: 16px;
      background: linear-gradient(135deg, rgba(15,23,42,0.85), rgba(30,64,175,0.7));
      backdrop-filter: blur(10px);
      font-size: 13px;
      line-height: 1.4;
      overflow: hidden;
    }

    #lyric-title {
      font-weight: 600;
      margin-bottom: 6px;
    }

    #lyric-body {
      opacity: 0.9;
      white-space: pre-wrap;
      font-size: 12px;
    }

    /* --- CONTROL PANEL --- */
    #control-panel {
      border-radius: 16px;
      padding: 14px 16px;
      background: linear-gradient(135deg,#020617,#0f172a);
      border: 1px solid #1f2937;
      display: flex;
      flex-direction: column;
      gap: 10px;
      position: relative;
      z-index: 10;
    }

    #control-panel h2 {
      font-size: 16px;
      margin-bottom: 4px;
    }

    #ai-debug {
      font-size: 13px;
      color: #9ca3af;
      max-height: 90px;
      overflow: auto;
      white-space: pre-wrap;
    }

    #mood-pill {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 3px 10px;
      border-radius: 999px;
      background: rgba(15,23,42,0.9);
      font-size: 11px;
      margin-left: 8px;
    }

    #live-comments {
      max-height: 120px;
      overflow-y: auto;
      background: rgba(15,23,42,0.5);
      border-radius: 8px;
      padding: 8px;
      font-size: 13px;
      line-height: 1.3;
      margin-top: 8px;
    }

    /* Floating incoming comment style */
    .floating-comment {
      position: absolute;
      pointer-events: none;
      z-index: 30;
      padding: 8px 12px;
      border-radius: 12px;
      background: rgba(0,0,0,0.6);
      color: #fff;
      font-size: 17px;
      backdrop-filter: blur(6px);
      transform-origin: center;
      animation: floatPop 5000ms ease forwards;
      filter: drop-shadow(0 6px 18px rgba(0,0,0,0.6));
      white-space: nowrap;
    }

    @keyframes floatPop {
      0% { opacity: 0; transform: translateY(10px) scale(0.9) rotate(-6deg); }
      10% { opacity: 1; transform: translateY(0) scale(1) rotate(0deg); }
      80% { opacity: 1; transform: translateY(-24px) scale(1.02) rotate(4deg); }
      100% { opacity: 0; transform: translateY(-48px) scale(0.98) rotate(2deg); }
    }

    /* --- ENCORE METER --- */
    #encore-container {
      position: absolute;
      top: 24px;
      left: 50%;
      transform: translateX(-50%);
      z-index: 999;                 /* always on top */
      text-align: center;
      pointer-events: none;
      animation: fadeInDown 0.8s ease-out;
    }

    #encore-title {
      font-size: 18px;
      font-weight: 800;
      color: #ffd700;
      text-shadow: 0 0 20px #000, 0 0 40px #ff6b6b;
      margin-bottom: 8px;
      letter-spacing: 2px;
    }

    .encore-bar {
      width: 340px;
      height: 28px;
      background: rgba(0,0,0,0.75);
      border: 2px solid #ffd700;
      border-radius: 14px;
      overflow: hidden;
      box-shadow: 0 0 30px rgba(255,215,0,0.6);
      backdrop-filter: blur(10px);
    }

    #encore-fill {
      width: 0%;
      height: 100%;
      background: linear-gradient(90deg, #ffd700, #ff9d00, #ff4444);
      border-radius: 12px;
      transition: width 0.8s cubic-bezier(0.4, 0, 0.2, 1);
      box-shadow: 0 0 20px #ff6b6b;
    }

    #encore-count {
      margin-top: 8px;
      font-size: 20px;
      font-weight: 900;
      color: #fff;
      text-shadow: 0 0 20px #ffd700;
    }

    /* MASSIVE ENCORE EXPLOSION (when 10 votes) */
    #encore-explosion {
      position: absolute;
      inset: 0;
      pointer-events: none;
      z-index: 1000;                /* even higher than meter */
      background: radial-gradient(circle at center, #ffc857 0%, #ff6b6b 50%, transparent 80%);
      opacity: 0;
      animation: encoreBlast 3.8s ease-out forwards;
      display: flex;
      align-items: center;
      justify-content: center;
      font-size: 140px;
      font-weight: 900;
      color: white;
      text-shadow: 0 0 60px gold, 0 0 120px #ff6b6b;
      backdrop-filter: blur(4px);
    }

    @keyframes encoreBlast {
      0%   { opacity: 0; transform: scale(0.3); }
      20%  { opacity: 1; transform: scale(1.1); }
      80%  { opacity: 0.8; transform: scale(1); }
      100% { opacity: 0; transform: scale(1.3); }
    }

    @keyframes fadeInDown {
      from { opacity: 0; transform: translateX(-50%) translateY(-20px); }
      to   { opacity: 1; transform: translateX(-50%) translateY(0); }
    }
  </style>
</head>
<body>
  <div id="top-bar">
    AURA â€” <span style="opacity:0.8;">Live Crowd + AI Demo</span>
  </div>

  <div id="layout">
    <!-- LEFT: STAGE -->
    <div id="stage-wrapper">
      <div id="encore-container">
        <div id="encore-title">ENCORE</div>
        <div class="encore-bar">
          <div id="encore-fill"></div>
        </div>
        <div id="encore-count">0/10</div>
      </div>
      <!-- Image background (default) -->
      <!-- <img id="background-content" src="1.jpg" alt="Stage Background Image" style="z-index: 1;"> -->

      <!-- Or video background -->      
      <video id="background-content" autoplay muted loop playsinline>
        <source src="1.mp4" type="video/mp4"/>
      </video>
      <script>
        const video = document.getElementById('background-content');

        // Detect if on mobile (iOS or Android)
        const isMobile = /iPhone|iPad|iPod|Android/i.test(navigator.userAgent);

        if (isMobile) {
          // Mobile: must be muted to autoplay
          video.muted = true;
          video.autoplay = true;
        } else {
          // Desktop: can have sound
          video.muted = false;
          video.autoplay = true;
          // Optional: lower volume so it's not too loud
          video.volume = 0.3;
        }

        // Ensure it starts playing (some browsers are strict)
        video.play().catch(() => {
          // If play() fails (very rare), fall back to muted autoplay
          video.muted = true;
          video.play();
        });
      </script>
     
      <!-- Lighting effects ABOVE background -->
      <div id="beam-layer" style="z-index: 2;">
        <div class="beam b1"></div>
        <div class="beam b2"></div>
        <div class="beam b3"></div>
      </div>

      <!-- AI filter and UI LAST (highest z-index) -->
      <div id="ai-filter" style="z-index: 3;"></div>

      <!-- QR code display -->
      <div style="position: absolute; top: 20px; right: 20px; z-index: 20;">
        <img src="https://api.qrserver.com/v1/create-qr-code/?size=120x120&data=https://eylssca.github.io/IBM/send" 
             alt="Scan to comment" style="border-radius: 12px; box-shadow: 0 4px 20px rgba(255,255,255,0.3);">
        <div style="text-align: center; font-size: 13px; margin-top: 4px; opacity: 0.8;">Scan to react live</div>
      </div>
    </div>

    <!-- RIGHT: CONTROL PANEL -->
    <div id="control-panel">
      <h2>Live Crowd AI <span id="mood-pill">Mood: â€”</span></h2>

      <div style="font-size:12px; opacity:0.85;">
        Crowd comments analyzed in real-time by AI â†“
      </div>

      <!-- Live comment feed -->
      <div id="live-comments">
        No comments yet...
      </div>

      <!-- ENCORE METER -->
      <!-- <div style="margin-top:14px;">
        <div style="font-size:13px; opacity:0.9; margin-bottom:6px; text-align:center;">
          Encore
        </div>
        <div class="encore-bar">
          <div id="encore-fill" style="width:0%; height:22px; background:linear-gradient(90deg,#ffd700,#ff6b6b); border-radius:8px; transition:width 0.7s cubic-bezier(0.4,0,0.2,1); box-shadow:0 0 16px rgba(255,215,0,0.5);"></div>
        </div>
        <div style="text-align:center; font-size:12px; margin-top:6px; color:#ffd700; font-weight:600;">
          <span id="encore-count">0</span>/10 votes
        </div>
      </div> -->

      <div id="lyric-wall" style="position:static; width:100%; max-height:160px; margin-top:8px; z-index:9;">
        <div id="lyric-title">Waiting for crowd...</div>
        <div id="lyric-body" style="font-size:12px; opacity:0.9;">Scan QR â†’ Send comments â†’ Watch AI react!</div>
      </div>

      <div id="ai-debug" style="margin-top:8px;"></div>

    </div>
  </div>

  <!-- Firebase SDKs -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

  <script>
    // Encore system
    let encoreVotes = 0;
    const ENCORE_THRESHOLD = 10;

    function addEncoreVote() {
      encoreVotes++;
      const percent = (encoreVotes % 10) * 10;
      document.getElementById('encore-count').textContent = encoreVotes % 10;
      document.getElementById('encore-fill').style.width = `${percent}%`;

      if (encoreVotes % 10 === 0) {
        triggerEncoreExplosion();
      }
    }

    function triggerEncoreExplosion() {
      const explosion = document.createElement('div');
      explosion.id = 'encore-explosion';
      explosion.textContent = 'ENCORE!!!';
      document.getElementById('stage-wrapper').appendChild(explosion);

      // Auto-remove after animation
      setTimeout(() => explosion.remove(), 3800);
    }

    const filterEl = document.getElementById('ai-filter');
    const lyricTitleEl = document.getElementById('lyric-title');
    const lyricBodyEl = document.getElementById('lyric-body');
    const debugEl = document.getElementById('ai-debug');
    const moodPill = document.getElementById('mood-pill');
    const liveCommentsEl = document.getElementById('live-comments');

    // Firebase config
    const firebaseConfig = {
      apiKey: "AIzaSyC34piii16GqYm_It_O4Qm3-5J-j0eJg4w",
      authDomain: "live-show-comments.firebaseapp.com",
      projectId: "live-show-comments",
      storageBucket: "live-show-comments.firebasestorage.app",
      messagingSenderId: "682418279340",
      appId: "1:682418279340:web:e97f0d4c1317eacddc2009",
      databaseURL: "https://live-show-comments-default-rtdb.asia-southeast1.firebasedatabase.app/"
    };

    firebase.initializeApp(firebaseConfig);
    const db = firebase.database();
    // Use a root ref to allow removal on load, and a query for last-20 listening
    const commentsRootRef = db.ref("comments");
    const commentsRef = commentsRootRef.limitToLast(20);

    // Clear comment records on every page load (server-side removal).
    commentsRootRef.remove()
      .then(() => { debugEl.textContent = 'Comment records cleared on page load.'; })
      .catch((e) => { console.warn('Failed to clear comments:', e); });

    // Store recent comments locally
    let recentComments = [];

    // For every incoming message: show floating UI and trigger AI analysis (serialized)
    commentsRef.on("child_added", async (snapshot) => {
      const data = snapshot.val();
      if (!data?.text) return;

      const text2 = data.text.toLowerCase();

      // ENCORE VOTE DETECTION
      if (text2.includes("encore")) {
        addEncoreVote();
      }

      recentComments.push(data.text);
      if (recentComments.length > 10) recentComments.shift();
      updateLiveFeed();
      showFloatingComment(data.text);
      // Trigger real AI analysis for the latest comment
      analyzeCrowdWithAI([data.text]);
    });

    // Show a floating comment on the stage for a few seconds
    function showFloatingComment(text) {
      const wrapper = document.getElementById('stage-wrapper');
      if (!wrapper) return;
      const el = document.createElement('div');
      el.className = 'floating-comment';
      el.textContent = text;

      // random position within wrapper (avoid edges)
      const w = wrapper.clientWidth;
      const h = wrapper.clientHeight;
      const left = Math.max(8, Math.floor(Math.random() * (w - 160)));
      const top = Math.max(8, Math.floor(Math.random() * (h - 60)));
      el.style.left = `${left}px`;
      el.style.top = `${top}px`;

      // slight random rotation to make it non-directional
      el.style.transform = `rotate(${(Math.random()-0.5)*12}deg)`;

      wrapper.appendChild(el);

      // remove after animation duration + small buffer (5s animation â†’ remove at ~5200ms)
      setTimeout(() => {
        el.remove();
      }, 5200);
    }

    // Restore missing UI helpers
    function updateLiveFeed() {
      liveCommentsEl.innerHTML = recentComments.length
        ? recentComments.map(c => `<div style="margin: 2px 0; opacity: 0.8;">${escapeHtml(c)}</div>`).join('')
        : 'No comments yet...';
      liveCommentsEl.scrollTop = liveCommentsEl.scrollHeight;
    }

    function escapeHtml(text) {
      const div = document.createElement('div');
      div.textContent = text;
      return div.innerHTML;
    }

    // Cloudflare Worker URL - This will now handle the secret API call
    const WORKER_PROXY_URL = "https://llm-cors-proxy.yishunchiu007.workers.dev";
    
    // AI call locking to avoid concurrent requests when many users send at the same time
    let aiRunning = false;
    let pendingRun = false;
    let pendingComments = null;

    // Call AI via the Worker to analyze recent comments and get stage plan
    async function analyzeCrowdWithAI(comments) {
      if (aiRunning) {
        pendingRun = true;
        pendingComments = comments;
        debugEl.textContent = "ðŸ¤– AI busy â€” queued latest comments.";
        return;
      }
      aiRunning = true;
      debugEl.textContent = "ðŸ¤– AI analyzing crowd (via Worker)...";

      try {
        // **CALL THE WORKER**
        const response = await fetch(WORKER_PROXY_URL, {
          method: 'POST',
          headers: {
            'Content-Type': 'application/json',
            // Add any custom header your worker expects to signal an AI plan request
            'X-Action-Type': 'ai-stage-plan' 
          },
          body: JSON.stringify({ comments: comments })
        });

        if (!response.ok) {
          throw new Error(`Worker failed with status ${response.status}: ${await response.text()}`);
        }

        const plan = await response.json();
        
        applyStagePlan(plan);
        debugEl.textContent = `âœ… AI Plan received from Worker: ${plan.effect}`;
      } catch (e) {
        debugEl.textContent = `Error calling AI Worker: ${e.message}`;
        moodPill.textContent = 'Mood: ðŸš¨';
      } finally {
        aiRunning = false;
        if (pendingRun) {
          pendingRun = false;
          const toRun = pendingComments || comments;
          pendingComments = null;
          analyzeCrowdWithAI(toRun);
        }
      }
    }

    function applyStagePlan(plan) {
      // Map incoming intensity (0.1-1.0) to percent and category (1..10)
      const inIntensity = Math.max(0.0, Math.min(1.0, plan.intensity ?? 0.5));
      const percent = Math.round(inIntensity * 100);
      const category = percent === 0 ? 0 : Math.min(9, Math.ceil(percent / 10) - 1);
      const strength = (category + 1) / 10; // 0.1 .. 1.0

      // 10-category â†’ effect mapping (light â†’ strong) with base (pale) and vivid colors + mood label
      const EFFECT_MAP = [
        { effect: 'SPARKLE', baseColor: '#e6f7ff', vividColor: '#7fd3ff', mood: 'âœ¨ Calm'}, // 1
        { effect: 'CHILL_WAVE', baseColor: '#eafcff', vividColor: '#4fd1e0', mood: 'ðŸŒŠ Chill'}, // 2
        { effect: 'COZY_MODE', baseColor: '#eef6ff', vividColor: '#60a5fa', mood: 'ðŸŒ™ Cozy'}, // 3
        { effect: 'PULSE_NEON', baseColor: '#f0fff4', vividColor: '#34d399', mood: 'ðŸ’¡ Pulse'}, // 4
        { effect: 'STROBE_BLUE', baseColor: '#f2f8ff', vividColor: '#3b82f6', mood: 'ðŸ”µ Strobe'}, // 5
        { effect: 'STROBE_RED', baseColor: '#fff3f3', vividColor: '#ef4444', mood: 'ðŸ”´ Strobe'}, // 6
        { effect: 'LASER_BURST', baseColor: '#fff0fb', vividColor: '#ff6ec7', mood: 'âš¡ Laser'}, // 7
        { effect: 'FIREWORKS', baseColor: '#fff8f0', vividColor: '#ffb020', mood: 'ðŸŽ† Fireworks'}, // 8
        { effect: 'ENCORE_GOLD', baseColor: '#fff9f2', vividColor: '#ffc857', mood: 'âœ¨ Encore'}, // 9
        { effect: 'RAINBOW_FLOW', baseColor: '#fff6fb', vividColor: '#ff4da6', mood: 'ðŸŒˆ Riot'} // 10
      ];

      const chosen = EFFECT_MAP[category];

      // Mix a pale base color and a vivid color according to strength so low categories look pale/calm and high are vivid/sharp
      function mixHexColors(a, b, t) {
        const pa = a.replace('#','');
        const pb = b.replace('#','');
        const ar = parseInt(pa.substring(0,2),16), ag = parseInt(pa.substring(2,4),16), ab = parseInt(pa.substring(4,6),16);
        const br = parseInt(pb.substring(0,2),16), bg = parseInt(pb.substring(2,4),16), bb = parseInt(pb.substring(4,6),16);
        const rr = Math.round(ar + (br - ar) * t);
        const rg = Math.round(ag + (bg - ag) * t);
        const rb = Math.round(ab + (bb - ab) * t);
        return `#${rr.toString(16).padStart(2,'0')}${rg.toString(16).padStart(2,'0')}${rb.toString(16).padStart(2,'0')}`;
      }

      const primaryHex = plan.primaryColor || mixHexColors(chosen.baseColor, chosen.vividColor, strength);
      const vividHex = mixHexColors(chosen.baseColor, chosen.vividColor, Math.min(1, strength + 0.25));

      // Visual strength depends on category (increasing): change opacity, saturation, blur â†’ sharpness
      filterEl.style.background = `radial-gradient(circle at 50% 20%, ${hexWithAlpha(primaryHex, 0.25 + strength*0.6)}, transparent 70%)`;
      filterEl.style.opacity = 0.08 + strength * 0.9; // subtle -> bold

      // Beams become more opaque, more saturated, and sharper as strength increases
      document.querySelectorAll('.beam').forEach((b, i) => {
        const beamOpacity = (0.03 + strength * 0.85);
        b.style.opacity = beamOpacity.toString();
        // blur reduces with strength to make beams sharper at high intensity
        const blurPx = Math.max(0.5, 4 - (strength * 3.5));
        b.style.filter = `blur(${blurPx}px)`;
        b.style.background = `radial-gradient(circle at 50% 0%, ${hexWithAlpha(vividHex, 0.95)}, transparent 65%)`;
      });

      // Update lyric / UI; show the category-mapped effect and mood
      lyricTitleEl.textContent = plan.mcLine || 'AI MC reacting to the crowd...';
      lyricBodyEl.textContent = `Effect: ${chosen.effect}\nIntensity: ${percent}% (category ${category + 1}/10)\n\n${plan.explanation || ''}`;
      moodPill.textContent = 'Mood: ' + chosen.mood;
      debugEl.textContent += `\n\n[Displayed plan: ${percent}% â†’ category ${category + 1} â†’ ${chosen.effect} / ${chosen.mood}]`;
    }

    function hexWithAlpha(hex, alpha) {
      const c = hex.replace('#', '');
      const r = parseInt(c.substring(0, 2), 16);
      const g = parseInt(c.substring(2, 4), 16);
      const b = parseInt(c.substring(4, 6), 16);
      return `rgba(${r},${g},${b},${alpha})`;
    }
  </script>
</body>
</html>

<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>AI Show Director Demo</title>
  <style>
    * { box-sizing: border-box; margin: 0; padding: 0; font-family: system-ui, -apple-system, BlinkMacSystemFont, sans-serif; }

    body {
      background: #050318;
      color: #fff;
      display: flex;
      flex-direction: column;
      height: 100vh;
      overflow: hidden;
    }

    #top-bar {
      padding: 10px 20px;
      font-size: 18px;
      font-weight: 600;
      background: linear-gradient(90deg,#0f172a,#1e293b);
      border-bottom: 1px solid #334155;
    }

    #layout {
      display: grid;
      grid-template-columns: 2fr 1fr;
      gap: 16px;
      padding: 16px;
      flex: 1;
      position: relative;
    }

    /* --- STAGE AREA --- */
    #stage-wrapper {
      position: relative;
      border-radius: 24px;
      overflow: hidden;
      background: radial-gradient(circle at top, #1d2b64, #050318);
      box-shadow: 0 0 40px rgba(0,0,0,0.7);
      display: flex;
      justify-content: center;
      align-items: center;
    }

    /* Background container for image or video */
    #background-content {
      position: absolute;
      inset: 0;
      width: 100%;
      height: 100%;
      object-fit: cover;
      z-index: 1;
    }

    #stage-wrapper * {
        mix-blend-mode: screen;
    }

    #crowd {
      position: absolute;
      inset: 0;
      background-image: radial-gradient(circle, rgba(255,255,255,0.15) 1px, transparent 1px);
      background-size: 8px 8px;
      opacity: 0.2;
      mix-blend-mode: screen;
      z-index: 3;
    }

    #beam-layer {
      position: absolute;
      inset: 0;
      pointer-events: none;
      mix-blend-mode: screen;
      z-index: 4;
    }

    .beam {
      position: absolute;
      width: 30%;
      height: 120%;
      top: -20%;
      background: radial-gradient(circle at 50% 0%, rgba(255,255,255,0.9), transparent 65%);
      opacity: 0.25;
      transform-origin: top center;
      animation: beamSwing 4s ease-in-out infinite alternate;
      filter: blur(3px);
    }
    .beam.b1 { left: 20%; }
    .beam.b2 { left: 50%; animation-delay: 1s; }
    .beam.b3 { left: 80%; animation-delay: 2s; }

    @keyframes beamSwing {
      0% { transform: rotate(-12deg);}
      100% { transform: rotate(12deg);}
    }

    /* hexagon stage platform */
    #stage-platform {
      position: absolute;
      left: 50%; top: 60%;
      transform: translate(-50%, -50%);
      width: 55%;
      aspect-ratio: 1 / 0.5;
      background: linear-gradient(135deg,#ff8cf0,#ffc857);
      clip-path: polygon(10% 0, 90% 0, 100% 50%, 90% 100%, 10% 100%, 0 50%);
      box-shadow: 0 0 40px rgba(255,120,255,0.8);
      z-index: 5;
    }

    /* AI color filter over everything */
    #ai-filter {
      position: absolute;
      inset: 0;
      mix-blend-mode: screen;
      background: radial-gradient(circle at 50% 20%, rgba(255,0,255,0.4), transparent 70%);
      opacity: 0.0;
      transition: opacity 0.4s ease, background 0.4s ease;
      z-index: 6;
      pointer-events: none;
    }

    /* lyric / chat wall */
    #lyric-wall {
      position: absolute;
      left: 20px;
      top: 20px;
      width: 32%;
      max-height: 60%;
      padding: 12px 18px;
      border-radius: 16px;
      background: linear-gradient(135deg, rgba(15,23,42,0.85), rgba(30,64,175,0.7));
      backdrop-filter: blur(10px);
      font-size: 13px;
      line-height: 1.4;
      overflow: hidden;
      z-index: 7;
    }

    #lyric-title {
      font-weight: 600;
      margin-bottom: 6px;
    }

    #lyric-body {
      opacity: 0.9;
      white-space: pre-wrap;
      font-size: 12px;
    }

    /* left username bubble */
    #user-badge {
      position: absolute;
      left: 4%;
      bottom: 12%;
      display: flex;
      align-items: center;
      gap: 8px;
      padding: 8px 12px;
      border-radius: 999px;
      background: rgba(15,23,42,0.85);
      backdrop-filter: blur(10px);
      font-size: 13px;
      z-index: 7;
    }

    #user-avatar {
      width: 28px; height: 28px;
      border-radius: 999px;
      background: radial-gradient(circle at 30% 20%, #fff, #f973ff);
      display: flex; align-items: center; justify-content: center;
      font-size: 16px;
    }

    /* --- CONTROL PANEL --- */
    #control-panel {
      border-radius: 16px;
      padding: 14px 16px;
      background: linear-gradient(135deg,#020617,#0f172a);
      border: 1px solid #1f2937;
      display: flex;
      flex-direction: column;
      gap: 10px;
      position: relative;
      z-index: 10;
    }

    #control-panel h2 {
      font-size: 16px;
      margin-bottom: 4px;
    }

    .btn-row {
      display: flex;
      gap: 8px;
      flex-wrap: wrap;
    }

    button {
      border-radius: 999px;
      border: none;
      padding: 6px 14px;
      font-size: 13px;
      cursor: pointer;
      background: linear-gradient(135deg,#4f46e5,#ec4899);
      color: #fff;
      box-shadow: 0 0 12px rgba(79,70,229,0.6);
      transition: transform 0.1s ease, box-shadow 0.1s ease, opacity 0.2s;
    }
    button.secondary {
      background: #111827;
      box-shadow: none;
      border: 1px solid #4b5563;
    }
    button:hover { transform: translateY(-1px); box-shadow: 0 0 16px rgba(236,72,153,0.7);}
    button:active { transform: translateY(0); box-shadow: 0 0 8px rgba(236,72,153,0.5); }

    textarea {
      width: 100%;
      min-height: 70px;
      resize: vertical;
      border-radius: 8px;
      border: 1px solid #4b5563;
      background: #020617;
      color: #e5e7eb;
      padding: 8px;
      font-size: 13px;
    }

    #ai-debug {
      font-size: 11px;
      color: #9ca3af;
      max-height: 90px;
      overflow: auto;
      white-space: pre-wrap;
    }

    #mood-pill {
      display: inline-flex;
      align-items: center;
      gap: 6px;
      padding: 3px 10px;
      border-radius: 999px;
      background: rgba(15,23,42,0.9);
      font-size: 11px;
      margin-left: 8px;
    }

    #live-comments {
      max-height: 120px;
      overflow-y: auto;
      background: rgba(15,23,42,0.5);
      border-radius: 8px;
      padding: 8px;
      font-size: 11px;
      line-height: 1.3;
      margin-top: 8px;
    }

    /* Floating incoming comment style */
    .floating-comment {
      position: absolute;
      pointer-events: none;
      z-index: 30;
      padding: 8px 12px;
      border-radius: 12px;
      background: rgba(0,0,0,0.6);
      color: #fff;
      font-size: 13px;
      backdrop-filter: blur(6px);
      transform-origin: center;
      animation: floatPop 5000ms ease forwards;
      filter: drop-shadow(0 6px 18px rgba(0,0,0,0.6));
      white-space: nowrap;
    }

    @keyframes floatPop {
      0% { opacity: 0; transform: translateY(10px) scale(0.9) rotate(-6deg); }
      10% { opacity: 1; transform: translateY(0) scale(1) rotate(0deg); }
      80% { opacity: 1; transform: translateY(-24px) scale(1.02) rotate(4deg); }
      100% { opacity: 0; transform: translateY(-48px) scale(0.98) rotate(2deg); }
    }
  </style>
</head>
<body>
  <div id="top-bar">
    AURA â€” <span style="opacity:0.8;">Live Crowd + AI Demo</span>
  </div>

  <div id="layout">
    <!-- LEFT: STAGE -->
    <div id="stage-wrapper">
      <!-- USE EITHER IMAGE OR VIDEO BELOW BY UNCOMMENTING ONE -->

      <!-- Image background (default) -->
      <img id="background-content" src="1.jpg" alt="Stage Background Image" style="z-index: 1;">

      <!-- Or video background (comment out the img above if using video) -->
      <!--
      <video id="background-content" autoplay muted loop playsinline>
        <source src="your-video.mp4" type="video/mp4" />
        Your browser does not support the video tag.
      </video>
      -->

      <!-- Lighting effects ABOVE background -->
      <div id="beam-layer" style="z-index: 2;">
        <div class="beam b1"></div>
        <div class="beam b2"></div>
        <div class="beam b3"></div>
      </div>

      <!-- AI filter and UI LAST (highest z-index) -->
      <div id="ai-filter" style="z-index: 3;"></div>

      <!-- QR code display -->
      <div style="position: absolute; top: 20px; right: 20px; z-index: 20;">
        <img src="https://api.qrserver.com/v1/create-qr-code/?size=120x120&data=YOUR_SEND_HTML_URL_HERE" 
             alt="Scan to comment" style="border-radius: 12px; box-shadow: 0 4px 20px rgba(255,255,255,0.3);">
        <div style="text-align: center; font-size: 11px; margin-top: 4px; opacity: 0.8;">Scan to react live</div>
      </div>
    </div>

    <!-- RIGHT: CONTROL PANEL -->
    <div id="control-panel">
      <h2>Live Crowd AI <span id="mood-pill">Mood: â€”</span></h2>

      <div style="font-size:12px; opacity:0.85;">
        Crowd comments analyzed in real-time by AI â†“
      </div>

      <!-- Live comment feed -->
      <div id="live-comments">
        No comments yet...
      </div>

      <!-- lyric / chat wall moved to the right control panel -->
      <div id="lyric-wall" style="position:static; width:100%; max-height:160px; margin-top:8px; z-index:9;">
        <div id="lyric-title">Waiting for crowd...</div>
        <div id="lyric-body" style="font-size:12px; opacity:0.9;">Scan QR â†’ Send comments â†’ Watch AI react!</div>
      </div>

      <div id="ai-debug" style="margin-top:8px;"></div>

    </div>
  </div>

  <!-- Firebase SDKs -->
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.23.0/firebase-database-compat.js"></script>

// ... (lines 1-383 of the HTML and CSS) ...
    <script>
        // --- UI ELEMENTS ---
        const stageEffectEl = document.getElementById('stage-effect');
        const mcLineEl = document.getElementById('mc-line');
        const debugEl = document.getElementById('debug-info');
        const commentListEl = document.getElementById('comment-list');

        // --- HUGGING FACE CONFIG ---
        // !!! IMPORTANT: REPLACE "YOUR_HUGGING_FACE_TOKEN_HERE" with your actual HF key. !!!
        const HF_TOKEN = "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"; 
        
        // This is the model you know is accessible in HK.
        const MODEL_ID = "meta-llama/Meta-Llama-3-8B-Instruct"; 
        
        // --- CORS PROXY CONFIG ---
        // We use a public proxy to bypass the CORS block.
        // NOTE: This sends your API key through a third-party service (Corsfix).
        // REVOKE KEY IMMEDIATELY AFTER THE DEMO.
        const CORS_PROXY = 'https://proxy.corsfix.com/'; 
        const TARGET_ENDPOINT = `https://api-inference.huggingface.co/models/${MODEL_ID}`;
        
        // Final endpoint is the proxy prepended to the target.
        const FINAL_API_ENDPOINT = `${CORS_PROXY}${TARGET_ENDPOINT}`;

        // --- FIREBASE CONFIG (Kept the same) ---
        const firebaseConfig = {
            apiKey: "AIzaSyC34piii16GqYm_It_O4Qm3-5J-j0eJg4w",
            authDomain: "live-show-comments.firebaseapp.com",
            projectId: "live-show-comments",
            storageBucket: "live-show-comments.firebasestorage.app",
            messagingSenderId: "682418279340",
            appId: "1:682418279340:web:e97f0d4c1317eacddc2009",
            databaseURL: "https://live-show-comments-default-rtdb.asia-southeast1.firebasedatabase.app/"
        };

        firebase.initializeApp(firebaseConfig);
        const db = firebase.database();
        const commentsRootRef = db.ref("comments");
        const commentsRef = commentsRootRef.limitToLast(20);
        
        // --- STATE VARIABLES & INIT ---
        let aiRunning = false;
        let pendingRun = false;
        let pendingComments = null;

        if (HF_TOKEN === "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") {
             debugEl.textContent = "âš ï¸ WARNING: Hugging Face Token not set. Please update the script in display.html!";
        } else {
             debugEl.textContent = "System Ready (via Corsfix Proxy). Waiting for crowd comments on Firebase.";
        }

        // Clear comment records on every page load
        commentsRootRef.remove().catch((e) => { console.warn('Failed to clear comments:', e); });

        // --- FIREBASE LISTENER ---
        commentsRef.on("child_added", async (snapshot) => {
            const data = snapshot.val();
            if (!data?.text) return;

            // Update UI list
            const li = document.createElement('li');
            li.textContent = `[${new Date(data.ts).toLocaleTimeString()}] ${data.text}`;
            commentListEl.prepend(li);
            if (commentListEl.children.length > 10) {
                commentListEl.removeChild(commentListEl.lastChild);
            }
            
            // Immediately analyze the new comment
            analyzeCrowdWithAI([data.text]);
        });
        
        // --- AI LOGIC (HF Inference API Structure) ---

        function extractJSONFromText(text) {
            try {
                // This regex captures content between the first { and the last }
                const match = text.match(/\{[\s\S]*\}/);
                if (match) {
                    return JSON.parse(match[0]);
                }
            } catch (e) {
                console.error("Failed to parse JSON:", e, "Raw Text:", text);
            }
            return null;
        }

        async function analyzeCrowdWithAI(comments) {
            if (aiRunning || HF_TOKEN === "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") {
                if (aiRunning) {
                   pendingRun = true;
                   pendingComments = comments;
                }
                return;
            }
            
            aiRunning = true;
            debugEl.textContent = "ðŸ¤– AI analyzing crowd comments via Hugging Face (via CORS Proxy)...";
            
            const prompt = `You are an AI show director. Analyze these live crowd comments and determine the stage effect, primary color (hex code), intensity (0.1-1.0), and a short MC line (20 words max).
            
            Comments:
            - ${comments.join('\n- ')}

            Output ONLY a single JSON object. Do not include markdown fences (like \`\`\`). The JSON structure MUST be:
            {"effect": "LASER_BURST|ENCORE_GOLD|STROBE_RED|STROBE_BLUE|PULSE_NEON|FIREWORKS|SPARKLE|CHILL_WAVE|COZY_MODE|RAINBOW_FLOW", "primaryColor": "#ffc857", "intensity": 0.5, "mcLine": "This is the line.", "explanation": "Brief reason for choice."}
            `;

            try {
                const response = await fetch(FINAL_API_ENDPOINT, {
                    method: "POST",
                    // NOTE: The Authorization header containing the key is sent to the PROXY first.
                    headers: {
                        "Content-Type": "application/json",
                        "Authorization": `Bearer ${HF_TOKEN}`
                    },
                    body: JSON.stringify({
                        inputs: prompt,
                        parameters: {
                            max_new_tokens: 256, 
                            temperature: 0.5,
                        }
                    })
                });

                if (!response.ok) {
                    const errorDetails = await response.json().catch(() => ({error: "Non-JSON response"}));
                    debugEl.textContent = `Proxy/Hugging Face API Error: ${response.status}. Details: ${errorDetails.error || 'Unknown Error'}.`;
                    return;
                }

                const data = await response.json();
                const rawText = data?.[0]?.generated_text;

                if (!rawText) {
                    debugEl.textContent = 'Hugging Face response missing generated text.';
                    return;
                }
                
                const plan = extractJSONFromText(rawText);

                if (plan && plan.effect) {
                    applyStagePlan(plan);
                    debugEl.textContent = `âœ… AI Plan: ${plan.effect} (${Math.round((plan.intensity ?? 0.5)*100)}%). MC: "${plan.mcLine}". Reason: ${plan.explanation}`;
                } else {
                    debugEl.textContent = `âŒ Failed to parse valid plan from AI. Raw: ${rawText}`;
                }

            } catch (e) {
                debugEl.textContent = `âŒ Final Network Error: ${e.message}. The proxy may be down, or the issue persists.`;
            } finally {
                aiRunning = false;
                if (pendingRun) {
                    pendingRun = false;
                    const toRun = pendingComments;
                    pendingComments = null;
                    analyzeCrowdWithAI(toRun);
                }
            }
        }

        // --- STAGE VISUALS CONTROL ---
        function applyStagePlan(plan) {
            // 1. Apply the primary color and intensity
            const intensity = Math.max(0.1, Math.min(1.0, plan.intensity || 0.5));
            const color = plan.primaryColor || '#FFFFFF'; 

            stageEffectEl.style.opacity = intensity;
            stageEffectEl.style.backgroundColor = color;
            
            // 2. Apply the specific effect class
            stageEffectEl.className = 'effect-' + (plan.effect || 'LASER_BURST');
            
            // 3. Display the MC line
            mcLineEl.textContent = plan.mcLine || "Let's make some noise!";
            mcLineEl.style.opacity = 1;

            // Fade the MC line out after a few seconds
            setTimeout(() => {
                mcLineEl.style.opacity = 0;
            }, 5000);
        }
    </script>
</body>
</html>
